<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFI Gironde - Calendrier formation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css"/>

    <link rel="canonical" href="https://cfi-gironde.fr/calendrier.html">

    <!--    ICONES      -->
    <link rel="icon" href="/img/web/logo.png" type="image/png">
    <link rel="shortcut icon" href="/img/web/favicon.ico" type="image/x-icon">
    <meta name="theme-color" content="#0a2a43">
    <meta name="background-color" content="#ccc">

    <!--      APPLE        -->    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CFI Calendrier">
    <link rel="apple-touch-icon" href="/img/web/apple-icon.png" sizes="180x180">

</head>

<!-- ical.js nécessaire -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>

<script>
// === Calendrier encapsulé pour éviter les collisions ===
document.addEventListener('DOMContentLoaded', function(){
(function(){
  const locale = 'fr-FR';
  const monthFormatter = new Intl.DateTimeFormat(locale,{month:'long',year:'numeric'});
  const timeFormatter  = new Intl.DateTimeFormat(locale,{hour:'2-digit',minute:'2-digit'});

  const grid   = document.getElementById('calGrid');
  const titleN = document.getElementById('calTitle');
  const alertN = document.getElementById('calAlert');
  const prev   = document.getElementById('calPrev');
  const next   = document.getElementById('calNext');

  function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
  function addMonths(d,n){return new Date(d.getFullYear(),d.getMonth()+n,1)}
  function isSameDay(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate()}
  function dateKey(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');}

  let currentMonth = startOfMonth(new Date());
  let eventsByDay = new Map();

  function windowRange(base){
    const viewStart = new Date(base.getFullYear(), base.getMonth()-1, 1);
    const viewEnd   = new Date(base.getFullYear(), base.getMonth()+2, 0, 23,59,59,999);
    return {viewStart, viewEnd};
  }
  function ensureBucket(d){ const k=dateKey(d); if(!eventsByDay.has(k)) eventsByDay.set(k, []); return k; }

  function occKeyFromICALTime(t){
    if(!t) return '';
    const pad = n => String(n).padStart(2,'0');
    if (t.isDate) return `D${t.year}${pad(t.month)}${pad(t.day)}`;
    return `T${t.toUnixTime()}`;
  }

  function pushSpan(s, e, payload, viewStart, viewEnd){
    const d0 = new Date(s.getFullYear(), s.getMonth(), s.getDate());
    const d1 = new Date(e.getFullYear(), e.getMonth(), e.getDate());
    for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
      if(d<viewStart || d>viewEnd) continue;
      const k = ensureBucket(d);
      eventsByDay.get(k).push({...payload, _isContinuation: !isSameDay(d, d0)});
    }
  }
  function durMsFrom(ev){
    if(ev.duration) return ev.duration.toSeconds()*1000;
    if(ev.startDate && ev.endDate) return (ev.endDate.toUnixTime()-ev.startDate.toUnixTime())*1000;
    return 0;
  }

  function buildIndexFromGroups(groups, singles){
    eventsByDay = new Map();
    const {viewStart, viewEnd} = windowRange(currentMonth);

    for(const g of groups.values()){
      const master = g.master; const exceptions = g.exceptions||[];
      if(!master) continue;

      const exMap = new Map();
      for (const ex of exceptions) {
        let ridTime = null;
        const ridProp = ex.component && ex.component.getFirstProperty('recurrence-id');
        if (ridProp) ridTime = ridProp.getFirstValue();
        else if (ex.recurrenceId) ridTime = ex.recurrenceId;
        if (ridTime) exMap.set(occKeyFromICALTime(ridTime), ex);
      }

      const exp = master.iterator();
      const masterDur = durMsFrom(master);
      let next;
      const seen = new Set();

      while((next = exp.next())){
        const js = next.toJSDate();
        if(js > viewEnd) break;
        if(js < viewStart) continue;

        const key = occKeyFromICALTime(next);
        seen.add(key);

        const use = exMap.get(key) || null;
        if(use){
          const s = use.startDate.toJSDate();
          const e = use.endDate ? use.endDate.toJSDate() : new Date(s.getTime()+masterDur);
          pushSpan(s, e, {summary: use.summary, dtstart: s, dtend: e, location: use.location, description: use.description}, viewStart, viewEnd);
        }else{
          const e = new Date(js.getTime()+masterDur);
          pushSpan(js, e, {summary: master.summary, dtstart: js, dtend: e, location: master.location, description: master.description}, viewStart, viewEnd);
        }
      }

      const rrule = master.component.getFirstPropertyValue('rrule');
      if(rrule && rrule.until){
        const u = rrule.until;
        const uKey = occKeyFromICALTime(u);
        if(!seen.has(uKey)){
          const use = exMap.get(uKey) || null;
          const uj = u.toJSDate();
          if(uj >= viewStart && uj <= viewEnd){
            if(use){
              const s = use.startDate.toJSDate();
              const e = use.endDate ? use.endDate.toJSDate() : new Date(s.getTime()+masterDur);
              pushSpan(s, e, {summary:use.summary, dtstart:s, dtend:e, location:use.location, description:use.description}, viewStart, viewEnd);
            }else{
              const e = new Date(uj.getTime()+masterDur);
              pushSpan(uj, e, {summary:master.summary, dtstart:uj, dtend:e, location:master.location, description:master.description}, viewStart, viewEnd);
            }
          }
        }
      }
    }

    for(const s of singles){
      const js = s.startDate.toJSDate();
      const je = s.endDate ? s.endDate.toJSDate() : new Date(js.getTime());
      if(je < viewStart || js > viewEnd) continue;
      pushSpan(js, je, {summary:s.summary, dtstart:js, dtend:je, location:s.location, description:s.description}, viewStart, viewEnd);
    }

    for (const arr of eventsByDay.values()) arr.sort((a,b)=>a.dtstart-b.dtstart);
  }

  function eventsForDay(day){ return eventsByDay.get(dateKey(day)) || []; }

  function renderCalendar(){
    titleN.textContent = monthFormatter.format(currentMonth).toUpperCase();
    grid.innerHTML = '';

    const start = startOfMonth(currentMonth);
    const startDay = (start.getDay()+6)%7; // lundi=0
    const total = 35;
    const today = new Date();

    const frag = document.createDocumentFragment();
    for(let i=0;i<total;i++){
      const cellDate=new Date(start);
      cellDate.setDate(cellDate.getDate()-startDay+i);
      const inMonth = cellDate.getMonth()==currentMonth.getMonth();

      const div=document.createElement('div');
      div.className='cal__day'+(inMonth?'':' out');
      if(isSameDay(cellDate,today)) div.classList.add('today');
      div.dataset.date=cellDate.toISOString();

      const badge=document.createElement('div');
      badge.className='cal__badge';
      badge.textContent=cellDate.getDate();
      div.appendChild(badge);

      const evs=eventsForDay(cellDate);
      const list=document.createElement('div'); list.className='cal__events';
      if(evs.length){
        div.classList.add('has-events');
        for(const ev of evs){
          const row=document.createElement('div');
          row.className='cal__chip'+(ev._isContinuation?' multi':'');
          const t0 = ev.dtstart ? timeFormatter.format(ev.dtstart) : '';
          row.innerHTML = (t0 ? `<span class="t">${t0}</span>` : '') + `<span class="s">${ev.summary || ''}</span>`;
          row.dataset.time = t0 || '';
          row.dataset.title = ev.summary || '';
          row.title = (t0 ? `${t0} — ` : '') + (ev.summary || '');
          list.appendChild(row);
        }
      }
      div.appendChild(list);
      frag.appendChild(div);
    }
    grid.appendChild(frag);

    adaptDayLayouts(); // responsive after render
  }

  // Responsive: heure seule / emoji si peu d'espace
  function emojiFor(title){
    const t = (title || '').toLowerCase();
    if (t.includes('bnssa')) return '🏊';
    if (t.includes('océan') || t.includes('ocean')) return '🌊';
    if (t.includes('secours')) return '🚑';
    if (t.includes('réunion')) return '📣';
    if (t.includes('ppg')) return '🏋️';
    if (t.includes('pilotage') || t.includes('embarcation')) return '🛶';
    return '📌';
  }

  function adaptOneDayCell(day){
    const evs = day.querySelectorAll('.cal__chip');
    if (!evs.length) { day.classList.remove('compact','icon'); return; }

    const rect = day.getBoundingClientRect();
    const badge = day.querySelector('.cal__badge');
    const badgeH = badge ? badge.getBoundingClientRect().height : 18;
    const available = rect.height - badgeH - 10;
    const manyEvents = evs.length >= 4;

    day.classList.remove('compact','icon');

    if (available < 70 || manyEvents) {
      day.classList.add('icon');
      evs.forEach((chip, i) => {
        const emoji = emojiFor(chip.dataset.title);
        chip.textContent = emoji;
        chip.title = chip.dataset.time ? `${chip.dataset.time} — ${chip.dataset.title}` : chip.dataset.title;
        chip.style.display = (i > 2 ? 'none' : '');
      });
      return;
    }

    if (available < 92) {
      day.classList.add('compact');
      evs.forEach(chip => {
        chip.innerHTML = chip.dataset.time ? `<span class="t">${chip.dataset.time}</span>` : '•';
        chip.title = chip.dataset.title ? `${chip.dataset.time || ''} ${chip.dataset.title}`.trim() : chip.title;
        chip.style.display = '';
      });
      return;
    }

    evs.forEach(chip => {
      chip.innerHTML = (chip.dataset.time ? `<span class="t">${chip.dataset.time}</span>` : '') +
                       `<span class="s">${chip.dataset.title}</span>`;
      chip.style.display = '';
    });
  }
  function adaptDayLayouts(){
    document.querySelectorAll('.cal__grid .cal__day').forEach(adaptOneDayCell);
  }

  function registerTzAliases(){
    if (!window.ICAL || !ICAL.TimezoneService) return;
    const TZ_ALIASES = {
      'Romance Standard Time': 'Europe/Paris',
      'W. Europe Standard Time': 'Europe/Berlin',
      'Central European Standard Time': 'Europe/Warsaw',
    };
    for (const [win, iana] of Object.entries(TZ_ALIASES)) {
      try {
        const zone = ICAL.TimezoneService.get(iana);
        if (zone) ICAL.TimezoneService.register(win, zone);
      } catch(e){}
    }
  }

  async function loadEvents(){
    alertN.classList.remove('show');
    try{
      const res=await fetch('calendar.ics',{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text=await res.text();

      registerTzAliases();

      const jcal=ICAL.parse(text);
      const comp=new ICAL.Component(jcal);
      const vevents=comp.getAllSubcomponents('vevent').map(v=> new ICAL.Event(v));

      const groups = new Map();
      const singles = [];
      for(const ev of vevents){
        const uid = ev.uid || (ev.component && ev.component.getFirstPropertyValue('uid')) || Math.random().toString(36).slice(2);
        const isExc = ev.isRecurrenceException && ev.isRecurrenceException();
        const isRec = ev.isRecurring && ev.isRecurring();
        if(isExc){
          if(!groups.has(uid)) groups.set(uid, {master:null, exceptions:[]});
          groups.get(uid).exceptions.push(ev);
        }else if(isRec){
          if(!groups.has(uid)) groups.set(uid, {master:null, exceptions:[]});
          if(!groups.get(uid).master) groups.get(uid).master = ev;
        }else{
          singles.push(ev);
        }
      }

      buildIndexFromGroups(groups, singles);
      renderCalendar();
    }catch(e){
      alertN.textContent="Impossible de charger calendar.ics : "+e.message;
      alertN.classList.add('show');
      console.error(e);
    }
  }

  // UI
  prev.addEventListener('click', ()=>{ currentMonth=addMonths(currentMonth,-1); loadEvents(); });
  next.addEventListener('click', ()=>{ currentMonth=addMonths(currentMonth, 1); loadEvents(); });

  document.getElementById('calGrid').addEventListener('click', (e)=>{
    const day = e.target.closest('.cal__day');
    if(!day) return;
    openModalForDate(day.dataset.date);
  });

function lock(){ 
  document.documentElement.classList.add('alb-noscroll'); 
  document.body.classList.add('alb-noscroll'); 
}
function unlock(){ 
  document.documentElement.classList.remove('alb-noscroll'); 
  document.body.classList.remove('alb-noscroll'); 
}



  function openModalForDate(dateISO){
    const modal=document.getElementById('eventModal');
    const body=document.getElementById('modalBody');
    const title=document.getElementById('modalTitle');
    if(!dateISO) return;
    const d=new Date(dateISO);
    const evs=eventsForDay(d);
    title.textContent = d.toLocaleDateString(locale, {weekday:'long', day:'2-digit', month:'long', year:'numeric'}).toUpperCase();
    body.innerHTML='';
    if(!evs.length){
      body.innerHTML='<div class="cal__meta">Aucun évènement</div>';
    }else{
      for(const ev of evs){
        const card=document.createElement('div'); card.className='cal__card';
        const h=document.createElement('h4'); h.textContent=ev.summary||'(Sans titre)';
        const meta=document.createElement('div'); meta.className='cal__meta';
        const t0 = ev.dtstart ? timeFormatter.format(ev.dtstart) : '';
        const t1 = ev.dtend? ' – '+timeFormatter.format(ev.dtend):'';
        meta.textContent = (t0?t0:'')+(t1?t1:'')+(ev.location?'\n'+ev.location:'');
        const extra=document.createElement('div'); extra.className='cal__meta'; extra.textContent = ev.description||'';
        card.append(h, meta, extra); body.appendChild(card);
      }
    }
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    lock(); 


  }

  // close modal: clic sur fond + ESC
  const modalClose = document.getElementById('modalClose');
  if (modalClose) modalClose.addEventListener('click', closeModal);
  document.getElementById('eventModal').addEventListener('click', (e)=>{ if(e.target.id==='eventModal') closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
  function closeModal(){
    const modal=document.getElementById('eventModal');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    unlock(); 

 
  }

  // Resize → recalcul
  window.addEventListener('resize', adaptDayLayouts);
  new ResizeObserver(adaptDayLayouts).observe(document.getElementById('calGrid'));

  // GO
  loadEvents();
})();
});
</script>




<body>
    <section class="accueil">
        <div class="overlay">   
            <div class="logo">
                <a href="https://monespace.snsm.org/s/login/?ec=302&startURL=%2Fs%2F" target="_blank">
                <img src="img/web/logo.png" alt="logo" /> </a>
            </div>

             <ul class="menu">
                    <li><a href="index.html" class="menu__link">Accueil</a></li>
                    <li class="has-submenu">
                        <a href="#" class="menu__link submenu-toggle">Formation</a>
                        <ul class="submenu">
                            <li><a href="formation-nageur-sauveteur.html" class="menu__link">Devenir Nageur Sauveteur</a></li>
                            <li><a href="formation-pse.html" class="menu__link">Filière professionelle - PSE</a></li>
                            <li><a href="formation-psc.html" class="menu__link">Filière citoyenne - PSC</a></li>
                        </ul>
                    </li>
                    <li><a href="calendrier.html" class="menu__link">Calendrier</a></li>
                    <li><a href="contact.php" class="menu__link">Contact</a></li>
                    <li><a href="photos.html" class="menu__link">Album</a></li>
                </ul>
            <div class="toggle">
                <i class="fas fa-bars ouvrir"></i>
                <i class="fas fa-times fermer"></i>
            </div>

            <div class="accueil__text">
                <div class="accueil__text__top">
                    <div class="sep"></div>
                    <p>Centre de formation et d'intervention de Gironde</p>
                </div>
                <div class="accueil__text__mid">
                    <h1>Calendrier promotion 2025-2026</h1>
                </div>
                <!-- <div class="accueil__text__bot">
                    <p>scroll down <i class="fas fa-long-arrow-alt-down"></i></p>
                </div> -->
            </div>
        </div>
    </section>

<!----------------------------- SECTION PRINCIPALE----------------------  -->
<!-- === Calendrier === -->
<section id="calendrier" class="cal">
  <main class="cal__root" aria-label="Calendrier mensuel">
    <header class="cal__header">
      <div class="cal__nav">
        <button id="calPrev" aria-label="Mois précédent">◀</button>
        <button id="calNext" aria-label="Mois suivant">▶</button>
      </div>
      <div class="cal__title" id="calTitle">Mois ANNÉE</div>
      <span></span>
    </header>

    <div class="cal__weekdays" aria-hidden="true">
      <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>

    <section class="cal__grid" id="calGrid"></section>
    <div id="calAlert" class="cal__alert" role="alert" aria-live="polite"></div>
  </main>

  <!-- Modal (overlay page) -->
  <div id="eventModal" class="cal__modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="cal__modal-card">
      <div class="cal__modal-head">
        <div class="cal__modal-title" id="modalTitle">Évènements</div>
        <!-- Croix masquée visuellement -->
        <button id="modalClose" aria-label="Fermer" class="cal__modal-close" hidden>✕</button>
      </div>
      <div class="cal__modal-body" id="modalBody"></div>
    </div>
  </div>
</section>
<!-- === /Calendrier === -->


 <!----------------------------- FOOTER----------------------  -->
 
    <section class="contact">
        <div class="footer-bottom">
                <img src="img/web/logo.png"> 
                <a href="index.html">
                    &copy; 2025 SNSM GIRONDE
                </a>
                <a href="https://www.instagram.com/cfi_gironde_snsm?igsh=MWJtZW82Z2Ntdm5meA==" target="_blank" aria-label="Instagram">
                    <img src="img/web/insta.png" alt="Instagram">
                </a>
        </div>
        <div class="footer"> 
            <a href="mentions.html">
                Mentions légales 
            </a>
        </div>
    </section>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js" integrity="sha512-UxP+UhJaGRWuMG2YC6LPWYpFQnsSgnor0VUF3BHdD83PS/pOpN+FYbZmrYN+ISX8jnvgVUciqP/fILOXDjZSwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="app.js"></script>
</body>
</html>